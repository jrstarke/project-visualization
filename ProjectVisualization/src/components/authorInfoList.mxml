<?xml version="1.0" encoding="utf-8"?>
<mx:Panel xmlns:mx="http://www.adobe.com/2006/mxml" layout="vertical" title="Authors" titleStyleName="authorStatusStyle" creationComplete="initParentProject()" verticalGap="0" borderThicknessBottom="5" borderThicknessLeft="5" borderThicknessRight="5">
	<mx:Style>
    	.authorStatusStyle {
        	fontWeight: bold;
            color: white;
     	}
     	
        .authorNameStyle	{
        	fontWeight: bold;
        }
        
        .authorLabelStyle	{
        	color: #4d4f4f;
        }
        
        .authorLabelStyleHighlight	{
        	color: white;
        }
	</mx:Style>
	
	<mx:Script>
		<![CDATA[
			import mx.controls.ProgressBar;
			import mx.rpc.http.HTTPService;
			import mx.collections.ArrayCollection;
			import mx.containers.HBox;
			import mx.containers.VBox;
			import mx.controls.Label;
			import mx.rpc.events.ResultEvent;
			import com.adobe.serialization.json.JSON;
			
			public var highlightedAuthor:int = 0;
			private var getSrvAuthors:HTTPService;
			private var getSrvAuthorStats:HTTPService;
			//create a list of the current authors in the main list
			public var authorList:Array = new Array();
			
			private var getParentProject:ProjectVisualizaton = new ProjectVisualizaton();
			
			//function to gain easy access to the parent class
			private function initParentProject():void
			{
				getParentProject =  this.parent.parent.parent.parent as ProjectVisualizaton;	
			}
			
			//add authors to author list
			public function addAuthorsToList(startDate:String, endDate:String):void
			{
				var numOfTopAuth:int = 18;

				getSrvAuthors = new HTTPService();
				getSrvAuthors.url = "http://localhost:8000/topauthors/" + startDate + "/" + endDate + "/" + numOfTopAuth + "/"; 
				getSrvAuthors.resultFormat = "text";
				getSrvAuthors.addEventListener("result", processAuthorList);
				
				if(endDate != null){
					getSrvAuthors.send();
					//debugLabel.text = getSrvEvents.url;
   				}	
			}
			
			private function processAuthorList(event:ResultEvent):void
			{
				//clear the list
				removeAuthorsFromList();
				
				var decoded:Object = JSON.decode(event.result.toString());
				var authorDictionary:Array = decoded as Array;
			
				authorList = authorDictionary;
				authorList = authorList.reverse();
					
				//authorList.addItemAt(author, 0);
				var i:int;
				for(i=0; i<authorList.length; i++){
					//check to see if the total number of events for an author is > 0
					//if((authorList[i].commitevents + authorList[i].newticketevents + authorList[i].ticketchangeevents) != 0)
					//{
						var authorHBox:HBox = new HBox();
						var authorNameLabel:Label = new Label();
						var authorProgressBar:ProgressBar = new ProgressBar();
			
						authorHBox.name = authorList[i].author + "";
						authorNameLabel.name = authorList[i].author + "Label";
						authorProgressBar.name = authorList[i].author + "Bar";
					
						authorNameLabel.text = "" + authorList[i].author_shortname;
						
						authorNameLabel.width = 72;
					
						authorHBox.setStyle("border", "none");
						authorNameLabel.styleName = "authorLabelStyle";
						
						authorHBox.setStyle("paddingTop",1);
						authorHBox.setStyle("paddingBottom",1);
						authorHBox.setStyle("paddingLeft",1);
						authorHBox.setStyle("paddingRight",1);	
						authorHBox.setStyle("verticalGap", 0);
						
						authorProgressBar.mode = "manual";
						authorProgressBar.label = "";
						authorProgressBar.labelPlacement = "right";
						authorProgressBar.setStyle("verticalCenter", 0);
						authorProgressBar.setStyle("verticalGap", 0);
						authorProgressBar.width = 50;
					
						authorHBox.addEventListener(MouseEvent.MOUSE_OVER, eventMouseOver);
						authorHBox.addEventListener(MouseEvent.CLICK, eventMouseClick);
				
						authorHBox.addChild(authorNameLabel);
						authorHBox.addChild(authorProgressBar);
						this.addChildAt(authorHBox, 0);
					//}	
				}	
			}
			
			//remove author from list if there that author no longer exists in the event list
			public function removeAuthorsFromList():void
			{
				this.removeAllChildren();
			}
			
			//perform click to hightlight the author name and set the filter
			private function eventMouseClick(e:MouseEvent):void
			{			
				var currentHBox:HBox = new HBox();
				currentHBox = e.currentTarget as HBox;
				var currentLabel:Label = new Label();
				currentLabel = currentHBox.getChildAt(0) as Label;
				var tempStyleName:String = currentLabel.styleName.toString();
					
				//reset all selected authors
				var i:int;
				for(i=0; i<authorList.length; i++)
				{
					var tempHBox:HBox = new HBox();
					tempHBox = getParentProject.authorInfoList.getChildByName(authorList[i].author) as HBox;
					
					var tempLabel:Label = new Label();
					tempLabel = tempHBox.getChildAt(0) as Label;
					tempHBox.opaqueBackground = 0xffffff;
					tempLabel.styleName = "authorLabelStyle";
				}
				
				//check to see if we must deselect a author
				if(tempStyleName != "authorLabelStyleHighlight"){
					currentHBox.opaqueBackground = 0x4d4f4f;
					currentLabel.styleName = "authorLabelStyleHighlight";
					highlightedAuthor = int(currentHBox.name);
					
					getSrvAuthorStats = new HTTPService();
					getSrvAuthorStats.url = "http://localhost:8000/selectedstats/" + highlightedAuthor + "/" + getParentProject.modulesList.highlightedModule + "/"; 
					getSrvAuthorStats.resultFormat = "text";
					getSrvAuthorStats.addEventListener("result", processAuthorStats);
					getSrvAuthorStats.send();
				}
				
				else
				{
					currentHBox.opaqueBackground = 0xffffff;
					currentLabel.styleName = "authorLabelStyle";
					highlightedAuthor = 0;
					
					getSrvAuthorStats = new HTTPService();
					getSrvAuthorStats.url = "http://localhost:8000/selectedstats/" + highlightedAuthor + "/" + getParentProject.modulesList.highlightedModule + "/"; 
					getSrvAuthorStats.resultFormat = "text";
					getSrvAuthorStats.addEventListener("result", processAuthorStats);
					getSrvAuthorStats.send();
				}
				
				//reset the events list
				getParentProject.eventInfoList.removeAllEventsFromList();
				getParentProject.eventInfoList.maxEventListCount = 0;
				getParentProject.controllerCanvas.eventIndex = 0;
				var index:int = 0;
				getParentProject.controllerCanvas.processAtPixelMoveStart(index);
			}
			
			private function processAuthorStats(event:ResultEvent):void
			{
				getParentProject.controllerCanvas.processGetResult(getSrvAuthorStats.lastResult.toString());
			}
			//perform mouse over effects, pause playback
			private function eventMouseOver(e:MouseEvent):void
			{
				getParentProject.controllerCanvas.eventTimer.stop();
				
				var currentHBox:HBox = new HBox();
				currentHBox = e.currentTarget as HBox;
				
				currentHBox.addEventListener(MouseEvent.MOUSE_OUT, eventMouseOut);

				currentHBox.setStyle("borderStyle", "solid");
				
				currentHBox.setStyle("paddingTop",0);
				currentHBox.setStyle("paddingBottom",0);
				currentHBox.setStyle("paddingLeft",0);
				currentHBox.setStyle("paddingRight",0);
				
				//highlight associated event if possible
				var i:int;
				for(i=0; i<getParentProject.eventInfoList.eventList.length; i++)
				{
					if(currentHBox.name == getParentProject.eventInfoList.eventList[i].author)
					{
						var eventHBox:HBox = new HBox();
						eventHBox = getParentProject.eventInfoList.getChildByName(getParentProject.eventInfoList.eventList[i].pk + "event") as HBox;
						eventHBox.setStyle("borderStyle", "solid");	
						
						eventHBox.setStyle("paddingTop",0);
						eventHBox.setStyle("paddingBottom",0);
						eventHBox.setStyle("paddingLeft",0);	
						eventHBox.setStyle("paddingRight",0);					
					}
				} 
			}
			
			//perform mouse out effects, resume playback
			private function eventMouseOut(e:MouseEvent):void
			{
				//check if the player is playing
				//removed for demo!
				//if(getParentProject.controllerCanvas.playerButton.source == "assets/images/button-icon-pause.png")
					getParentProject.controllerCanvas.eventTimer.start();
				
				var currentHBox:HBox = new HBox();
				currentHBox = e.currentTarget as HBox;
				currentHBox.setStyle("borderStyle", "none");
				
				currentHBox.setStyle("paddingTop",1);
				currentHBox.setStyle("paddingBottom",1);
				currentHBox.setStyle("paddingLeft",1);
				currentHBox.setStyle("paddingRight",1);
				
				currentHBox.removeEventListener(MouseEvent.MOUSE_OUT, eventMouseOut);
				
				//unhighlight all events from the event list
				var i:int;
				for(i=0; i<getParentProject.eventInfoList.eventList.length; i++)
				{
					var eventHBox:HBox = new HBox();
					eventHBox = getParentProject.eventInfoList.getChildByName(getParentProject.eventInfoList.eventList[i].pk + "event") as HBox;
					eventHBox.setStyle("borderStyle", "none");	
					
					eventHBox.setStyle("paddingTop",1);
					eventHBox.setStyle("paddingBottom",1);
					eventHBox.setStyle("paddingLeft",1);
					eventHBox.setStyle("paddingRight",1);					
				} 
			}
		]]>
	</mx:Script>
</mx:Panel>
